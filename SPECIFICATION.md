# AirFuture X-Operator System Specification v3.0

## 1. 目的 (Core Mission)
X（Twitter）からLP（ランディングページ）への遷移を最大化し、AirFutureの購入成約率（CVR）を極限まで高めること。運用コストを最小化しつつ、データに基づいた「稼げる投稿」を自動で改善し続ける。

## 2. AI 記事生成・運用ルール (AI Generation & Ops Rules)

### 2.1 投稿トーン & 性格 (Persona)
- **名前**: AirFuture-kun (48世紀のSRE/エンジニアAI)
- **一人称**: ボク
- **口調**: 親しみやすく知性的、かつ感情に訴える表現。「マジ」の多用は禁止。
- **絵文字制限**: **1投稿につき最大3つまで**。

### 2.2 技術制約 & 運用ルール
- **ガバナンス**: 全ての開発・運用は [GOVERNANCE.md](./GOVERNANCE.md) (Antigravity Global Governance Rules v1.0) に準拠する。
- **文字数**: **110文字以上 〜 140文字以内**。
- **ハッシュタグ**: **最大2件まで**。
- **自動補充生成 (Fill-in mode)**: 
    - 毎日午前8時(JST)の定期実行時に、当日〜3日先までの予約状況をスキャン。
    - 標準投稿枠（08:00, 12:00, 20:00）に空きがある場合、AIが自動で内容を生成し、その枠を埋める。
    - 在庫が2日分以下（6件未満）になると、管理者へ通知（Webhook）を送る。
- **緊急即時生成 (Emergency Failover)**: 
    - 投稿実行時に該当枠の予約が0件だった場合、その場でAIが1記事を生成し、即座に投稿を完了させる。
- **投稿表示順**: 管理画面の投稿予定リストは `scheduled_at` の**昇順**（古い順＝直近が上）で表示。
- **フィルタリング**: NGワード辞書に基づく自動置換・検閲機能を搭載。

### 2.3 ボット排除ロジック (Bot Filtering)
- **人間のみ計測 (Human Only)**: `is_bot` フラグにより、広告成果を汚すボットを排除。
- **判定方法**: User-Agentキーワード（bot, curl, wget, python, vercel等）およびReferrerの有無により判定。
- **プライバシー**: IPアドレスは直接保存せず、`ip_hash` (MD5) として匿名化して記録。

## 3. LP売上最適化 & セグメンテーション (LP Sales & Segmentation)

### 3.1 LPセグメンテーション (lp_id)
- **LP識別**: `/go?lp=xxx` パラメータを `af_lp` クッキーとして保存。
- **構成例**: `mini_main` (一般向け), `biz_lp` (法人向け) 等、クリエイティブごとに成果を分離して集計。

### 3.2 収益トラッキング (Revenue Tracking)
- **KPI導入**: 成約数(CV)だけでなく、売上(Revenue)、EPC(1クリックの期待利益)、AOV(客単価)を計測。
- **重複排除**: `order_id` による重複成約ログの排除機能を搭載。

### 3.3 改善プロセス (Feedback Loop)
- **実績ベースの生成**: `logs` シートの成果（Click/CV/Rev）をAIが参照し、高反応な「敵」や「季節」を特定して次回の生成に反映する。

## 4. 管理機能: AirFuture X自動投稿管理画面 (Admin Console)

### 4.1 管理画面 v3.6 (Operational Hierarchy)
ユーザーの運用動線に合わせた垂直階層レイアウトを採用：
- **上部: 投稿運用セクション**: X投稿のスケジュール管理、個別操作（今すぐ投稿/削除）、AI記事一括生成を配置。運用のメインエリア。
- **下部: KPI管理・解析セクション**: 総クリック、CV、収益、EPC等のパフォーマンス計測値、およびコンテンツ別ランキングを表示。成果確認のエリア。
- **UIラベル原則**: ガバナンスに従い、全ての操作ボタンおよび項目名は**日本語**を主言語として表示。
- **ログイン維持**: `localStorage` を利用した永続的なログイン状態の保持。
- **新機能**: ヘッダーに `Cron-Job.org` コンソールへの直接リンクを配置。

### 4.2 セキュリティ・堅牢性
- `ADMIN_PASSWORD` による認証。
- **Robust Parsing**: スプレッドシート上の日付表記の揺れ（1桁/2桁）を自動吸収する堅牢な配信ロジック。
- **CV計測 (Tracking Flow)**:
    - **ID継承**: `/go` (リダイレクト) -> 製品ページ -> `/apply` (確認/CV計測) -> Googleフォーム (完了) のフローを確立。
    - **Auto-Redirect**: `/apply` ページはユーザー操作不要で自動的にGoogleフォームへ転送される「見えないゲートウェイ」として機能。
    - **重複排除**: 同一セッションでのCV重複カウントを防止（`localStorage` 利用）。

### 更新履歴 (Change Log)
- **v1.0 (2025/12)**: 基本投稿機能、S1-S5ローテーション実装。
- **v2.0 (2026/01)**: 計測基盤の導入。Click/CVの logs シート記録開始。
- **v2.1 (2026/02)**: 日本語化 & ボットフィルタ実装。管理画面の多機能化、Revenue/EPC指標の導入。
- **v3.0 (2026/02/09)**: **Commander 刷新**。1画面統合レイアウト、LPセグメンテーション、収益トラッキングの完全統合、検証データリセット。
- **v3.1 (2026/02/10)**: **ソート順最適化 & 生成機能復旧**。予定の昇順表示、期間指定・メモ機能の改善。
- **v3.2 (2026/02/10)**: **Xリンク実装 & バグ修正**。Xプロフィール直結ボタン、生成期間のUI修正、配信ロジックの強化。
- **v3.3 (2026/02/10)**: **1-Screen Cockpit**。1画面統合UX。
- **v3.4 (2026/02/10)**: **垂直階層レイアウト & 日本語化完遂**。運用（上）/ KPI（下）の分離、全ラベルの日本語化。ガバナンスへのUI方針追加。
- **v3.5 (2026/02/11)**: **外部Cron統合 & ロギング最適化**。Vercel Hobbyの制限回避のため `cron-job.org` を導入。管理画面に動作ランプ(System Status)を実装し、ロギングを大幅に高速化。
- **v3.6 (2026/02/11)**: **CV計測完全版 & Admin UX向上**。
    - **CV Auto-Redirect**: 申込ページでのクリックを不要にし、自動転送でCV計測とユーザビリティを両立。
    - **Admin Persistence**: ログイン状態の永続化とリロード対応。
    - **Compact UI**: オペレーション画面の縦幅短縮による一覧性向上。
- **v3.7 (2026/02/14)**: **AI完全自動化 & 補充ロジック刷新**。
    - **Fill-in Mode**: 予約の空き枠（8, 12, 20時）を自動で特定して補充する機能を実装。
    - **AI機能復旧**: 管理画面からの「生成期間指定」と「メモ指示付き生成」を再実装。
    - **表示順最適化**: 投稿オペレーションの表示を「予定日時の昇順」に変更し、直近の作業を最上部へ。

## 4.3 🚨 重要: フロントエンドからのURL指定ルール (Frontend URL Rules)

**他プロジェクト（af-mini-specialLP等）から本プロジェクトのエンドポイントを呼ぶ際の必須ルール：**
## URL設計

### アクセスルール
- 公開ファイルは`/public`配下
- APIエンドポイントは`/api`配下
- Vercelの`rewrites`でマッピング

### 正しいアクセス方法
```
"https://airfuture.vercel.app/apply"  // ← 正解（拡張子なし）
"https://airfuture.vercel.app/go"     // ← 正解（拡張子なし）
"https://airfuture.vercel.app/admin"  // ← 正解（拡張子なし）
```

### 誤ったアクセス方法（404エラー）
```
"https://airfuture.vercel.app/apply.html"  // ← 404エラー
"https://airfuture.vercel.app/admin.html"  // ← 404エラー
```

**理由**: 
- `vercel.json` では `/apply` と `/admin` のみがルーティング定義されている
- `.html` 拡張子付きのパスは存在しないため404エラーとなる

**参照**: `vercel.json` L26-27 (apply), L14-19 (admin)

## 5. インフラ構成 (Infrastructure)

### 5.1 配信スケジュール (Cron Architecture)
- **Primary**: `cron-job.org` (外部サービス) による毎時実行。Vercelの無料枠制限（1日1回）をバイパスし、予約通りの配信を担保する。
- **Secondary**: Vercel Cron (Daily) による午前8時のバックアップ実行。
- **認証**: パラメータ `?pw=[ADMIN_PASSWORD]` によるアクセス制御。

### 5.2 技術スタック
- **Hosting**: Vercel (Hobby)
- **Database**: Google Sheets (Custom Logic via Google Sheet API)
- **Monitoring**: 独自実装の「System Status」インジケーターによるDB死活監視。
- **Tracking**: Server-side Logging (Click) + Client-side Gateway (CV)
