# CHANGELOG - AirFuture X-Operator

## [v6.4] - 2026-02-28
### Fixed
- **プレースホルダー排除 (Anti-Placeholder Check)**:
  - 投稿テキストに `[URL]` や `[YourProfileURL]` といったAI特有の仮文字列が含まれている場合、投稿を中止し自動でリトライ（再生成）するバリデーションを実装。
- **自動洗浄機能 (Auto-Sanitization)**:
  - 投稿の最終フェーズで、万が一プレースホルダー（ブラケット記号 `[]`）が含まれていた場合、それらを物理的に除去し、自然な文章のみを配信するガードレールを強化。
- **CTA指示の具体化**:
  - AIに対しプレースホルダーの使用を厳禁し、代わりに「プロフィールのURLに置いておきます」等の自然な日本語フレーズを使用するようプロンプトを再定義。

## [v6.3] - 2026-02-23
### Added
- **「絶対ルール」の制定 (Enforcement of Absolute Rules)**:
  - [GOVERNANCE.md](./GOVERNANCE.md) に「人間らしさの絶対正義」条項を追加。
  - 過去投稿の「前方10文字一致」による物理的な重複排除をシステムの最高法規として定義。
- **自律運用機能の明文化 (Self-Sustaining Operations)**:
  - 記事在庫が不足した際の「自動補充ロジック（Auto-Replenish）」が、新ルール（Gemini 2.0 + 独自性チェック）を継承して動作することを仕様書に明記。

## [v6.2] - 2026-02-23
### Fixed
- **AI生成エンジンの復旧と強化 (AI Recovery & Evolution)**:
  - 権限・エンドポイント起因の生成エラーを解決するため、`gemini-2.0-flash` へ移行。
  - プロンプトを刷新し、指定件数（count）の厳守と、より自然な「人間らしい」フックの多様化を実現。
- **投稿予約スロット不整合の修正 (Slot Synchronization)**:
  - スプレッドシート上の `slot_id` と `scheduled_at` の不整合により、自動生成がスキップされていた問題を解消。

### Added
- **セキュリティ・環境変数ガバナンス (Security Governance)**:
  - ローカル環境を Vercel プロジェクトにリンクし、`.env.local` による安全な環境変数管理へ移行。
  - GitHub への秘密情報流出を構造的に遮断。
- **多様性検証テスト (Diversification Testing)**:
  - 5つの異なるテーマ（3Dプリンター、ペット、睡眠、仕事、技術）での AI 生成を実証。

## [v6.1] - 2026-02-22
### Changed
- **仕様ドキュメントの完全統合 (Specification Consolidation)**:
  - これまでの全アップデート（v1.0〜v6.0）の内容を `SPECIFICATION.md v6.0` に集約。
  - 最新の運用ルール、ガバナンス、システム構成、および予算情報を一元管理。

### Added
- **プロジェクト予算・体制の更新 (Budget Update)**:
  - デザイン & UX制作費（¥600,000）を計入し、初期構築総額を ¥2,100,000 (税別) に改定。
- **LPデザインのプレミアム刷新 (High-End LP Design)**:
  - `af-mini-specialLP` において、ダークネイビーを基調としたモダンなデザイン、Noto Sans JPの採用、およびCVR向上のためのミッドページCTAを実装。

## [v6.0] - 2026-02-22
### Added
- **完全独自性担保ロジック (Uniqueness Guardian)**:
  - 過去の全ての投稿内容の **「前方10文字」** をデータベースから抽出し、生成された新規記事が1件でも重複していれば自動でリトライ（最大3回）する厳格なバリデーションを実装。
  - これにより「2度と同じ書き出し、同じ内容の記事」を作らないことを物理的に保証。
- **リアルタイムトレンド連動 (Live Trends Sync)**:
  - `NewsService` を新規実装。Google News RSSから「空気清浄機」「花粉」「3Dプリンタ」等の最新トピックスを毎時取得し、AIのプロンプトへ動的に反映。
  - 最新のニュースをベースにした「今、人間が書いている」空気感を強化。
- **トピック・シャッフル (Dynamic Topic Rotation)**:
  - 10種類以上のトピック候補から毎回ランダムに視点を選別し、AIに与える指示を動的に変化させることで、生成のマンネリ化を完全に根絶。

## [v5.0] - 2026-02-21
### Added
- **「超安全モード (Super Safety Mode)」の導入**: X（旧Twitter）のスパム判定を回避し、アカウントの「人間っぽさスコア」を最大化するための抜本的更新。
- **操作ジッター (Operational Jitter)**: 
  - 投稿処理の直前に **1秒〜5秒のランダムな待機時間** を挿入。ボット特有の「毎分00秒の機械的な操作パターン」を完全に排除。
- **URL/CTA比率の動的制御**:
  - 生成記事の **50%を「純粋な雑談・気づき」** とし、プロフィールへの誘導文（CTA）を完全に排除。残りの半分もプロフィール言及に留め、外部リンクを直接貼らない運用へ移行。
- **投稿時間の超ランダム化**:
  - 投稿枠を1日2回（朝・昼）に集約し、さらに **±60分〜120分の大幅な時間ゆらぎ** を付与。毎日異なる時間に投稿される自然なスケジュールを実現。

### Changed
- **AIペルソナの刷新**: 「マーケター」から **「空気質に憑りつかれた個人研究者」** へ。専門知識をひけらかすのではなく、日常の些細な発見（結露、埃、コーヒーの味など）を独り言のように呟くトーンへ変更。
- **ハッシュタグの完全禁止**: `#airfuture` を含む全てのハッシュタグを禁止し、宣伝臭を徹底的に排除。
- **Vercel実行制限への最適化**: ランダム待機時間をVercelの10秒制限（Hobbyプラン）に収まるよう調整し、安定性を確保。

### Removed
- **20:00投稿枠の廃止**: 夜間のボット投稿とみなされやすい20時台の自動スケジュールを削除。

## [v4.11] - 2026-02-20
### Added
- **多様性強制プロンプト (Perosona Rotation)**:
  - 記事ごとに「科学者」「共感する友人」「コーチ」の3つのペルソナを強制的に切り替えるロジックを実装。
  - 「ご存知ですか？」「皆さんこんにちは」等の定型句をシステムレベルで禁止し、金太郎飴のような生成結果を根絶。

## [v4.10] - 2026-02-20
### Fixed
- **スマート・スケジューリング (Smart Slot Finding)**:
  - 従来の「日時固定」による生成方式を廃止。
  - 既存の予約スケジュールと過去の投稿をスキャンし、**「空いている未来の枠（08:00, 12:00, 20:00）」** を自動的に探索して記事を埋めるロジックへ刷新。
  - これにより、既に予約がある日の生成で発生していた `slot_taken` エラーを完全解消。

## [v4.9] - 2026-02-20
### Changed
- **生成単位の変更**: 管理画面での指示を「生成日数 (Days)」から**「生成記事数 (Articles)」** へ変更。
- **UI統合**: 「物語形式」「リスト形式」の分岐を廃止し、単一の「✨ 生成」ボタンに統合。プロンプト側で自動的に最適な形式を選択するように変更。
- **通知可視性の改善**: Toast通知の `z-index` を `11000` に引き上げ、モーダルの裏に隠れる問題を修正。

## [v4.8] - 2026-02-20
### Improved
- **類似度判定の緩和**: 日本語テキストにおける判定閾値を `0.8` から `0.95` へ緩和し、正当な記事が誤って「重複」と判定される問題を修正。
- **モックデータの多様化**: API障害時（またはテスト時）に使用されるフォールバックデータについて、各トピックごとに3種類の異なるアングル（科学・感情・解決）を用意し、テスト生成時の体験を向上。

## [v4.7] - 2026-02-19
### Tweak
- **デプロイ検証用エンドポイント更新**: `/api/ping` に詳細なバージョン番号を付与し、修正反映確認を迅速化。

## [v4.6] - 2026-02-19
### Added
- **AEO (Answer Engine Optimization) 生成エンジンの導入**: 
  - AI検索時代に最適化された「結論先行型」の記事生成プロンプトへ全面移行。
  - 最新の2026年2月の研究データ（3DプリンターのVOCs/レジン有害性等）を動的に注入。
  - 記事末尾への「ランダム識別子（ソルト）」付与により、同一トピックの連続生成・予約時の重複スキップを完全に解消。
- **データサービスの堅牢性強化**: 
  - Vercel等の書き込み制限環境（Read-only FS）でのエラーを抑制するディレクトリ自動生成・例外処理を追加。
  - Google Sheetsとの連携瞬断時もシステムが停止しないフォールバック処理を強化。

## [v4.5] - 2026-02-17
### Added
- **メディア連動エンジンの土台構築 (Media Mapping Engine Prototype)**: 
  - 投稿内容から「花粉」「ペット」「3Dプリンタ」「歯科」のカテゴリを判別するロジックを実装。
  - 素材（動画4点、画像4点）が準備され次第、即座に自動添付を開始できるフックを投稿システムに追加。
  - 日付（偶数・奇数）で動画と画像を交互に選択するバリエーション機能を準備。

## [v4.4] - 2026-02-17
### Added
- **花粉・季節インテリジェンス (Daily Pollen Check)**: 
  - `PollenService` を新規実装。日本の予報サイト（Tenki.jp等）から毎日最新の花粉飛散レベルを自動取得。
  - AI生成時のコンテクストに「今日の花粉レベル：非常に多い/少ない等」を動的に注入する仕組みを構築。
- **季節テーマの自動移行**: `2月15日` を境に「冬」から「春（花粉シーズン）」へ自動でテーマを切り替えるロジックを導入。

### Changed
- **生成プロンプトの厳格化**: 「冬の表現」を禁止し、現在の花粉状況に基づいた具体的な共感フレーズ（くしゃみ、目のかゆみ、深呼吸等）を優先するように強化。

## [v4.3] - 2026-02-16
### Added
- **ブランディング・生成ルール (`branding_generation_rules.md`)**: 画像・動画生成時に `favicon.png` をマスターモデルとして強制使用し、`public/images` の既存素材を優先するルールを策定。
- **管理画面の利便性復元**: 配信済みリストからの「X現物リンク」、Cron設定ページ、操作台帳（Spreadsheet）へのダイレクトアクセスを再配置。

### Changed
- **API消費の極限抑制**: `check_metrics` タスクの遡及範囲を直近72時間から **48時間（2日）** に短縮。429エラー検知時に即時中断するガードを追加し、定時投稿枠を死守。

## [v4.2] - 2026-02-16
### Changed
- **DataService の日本語ラベル化**: スプレッドシート上の `is_bot`, `is_dev` 判定を「BOT/人間」「開発者/一般」という日本語表記に対応。管理画面のフィルタリングロジックと完全同期。

## [v4.1] - 2026-02-16
### Added
- **スマート・リトライ（自動文面修復）機能**: X APIエラー（429/スパム判定/重複検知）発生時、文末に異なる絵文字を自動付与して「別投稿」として再送を試みることで、手動介在なしでの復旧率を向上。
- **管理画面コントロールボタン**: 「統計更新（X API消費）」「記事補充（AI消費）」を手動で実行できるボタンを新設。不必要なAPI消費を抑制。

### Changed
- **Cron実行周期の最適化**: X APIの制限リセット周期（15分）に合わせ、15分おきの実行にシステム全体を最適化。
- **定期実行の軽量化**: 自動の定期実行時は「投稿」タスクのみを実行し、API 429エラーを回避する構成に強化。

## [v4.0] - 2026-02-16

## [v3.9] - 2026-02-16
### Added
- **時間ゆらぎ（Jitter）機能**: 投稿予約時に0〜7分のランダムな遅延を付与し、機械的な投稿パターンを排除（対ボット検知強化）。
- **スロット一意性（Slot ID）制約**: `YYYYMMDD-HH` 形式の識別子を導入し、同一時間枠への重複生成・投稿を物理的に不可能に。

### Changed
- **AI生成アルゴリズムの多様化**: 直近の投稿（10件）をAIにフィードバックし、表現やキーワードの重複を自動回避するようプロンプトを強化。
- **Cron判定バッファの最適化**: 10分おきのCron実行と「ゆらぎ」を確実にキャッチするため、判定猶予を5分から10分に拡大。

## [v3.8] - 2026-02-14
### Fixed
- **Vercel デプロイ復旧**: プロジェクト構成とVercelのRoot Directory設定の不整合を解消し、404エラーを全面的に修正。
- **Lambda実行エラーの解消**: `vercel.json` のリライト先から `.js` 拡張子を除去し、ソースコードの露出を防ぎAPIが正しく実行されるように修正。

### Added
- **プロジェクト・ガバナンス (GOVERNANCE.md)**: 構成の破壊を防ぎ、安全な運用を継続するためのメンテナンス規約を策定。
- **保守用ワークフロー**: AIエージェントが誤って構成を破壊しないための `.agent/workflows/maintenance_rules.md` を導入。
- **疎通確認用ツール**: 本番環境の計測ログやヘッダーを点検するための `check_logs.js` 等のスクリプトを整備。

## [v3.7] - 2026-02-14
### Added
- **補充型AI生成 (Fill-in mode)**: 毎日午前8時の定期実行時に、空いている投稿枠（8, 12, 20時）を自動検知してAIが補充する機能を実装。
- **AI指示機能の強化**: 管理画面からの「生成期間(Days)指定」および「自由なメモによる追加指示」が可能なUIを再実装。

### Changed
- **ソート順の最適化**: 投稿予定リストを `scheduled_at` の昇順に変更。直近の投稿予定が一番上に表示されるように改善。

## [v3.6] - 2026-02-12 (Latest)
### Changed
- **Vercelプロジェクト統一**: 重複していた `x-autoup` プロジェクトを削除し、`airfuture` プロジェクトに一本化。
- **URL参照の統一**: 全ドキュメントおよびコード内の参照を `airfuture.vercel.app` に統一。

### Fixed
- **ボタン動作問題**: 「今すぐ投稿」ボタンのネイティブ `confirm()` ダイアログが消える問題を、カスタムモーダルに置き換えて解決。
- **リダイレクトページ**: 画像読み込みエラーを解消し、CSSアニメーションのみのローディング画面に変更。

### Prepared
- **複数LP展開の準備**: 歯科、3Dプリンタ、ペット用LPの追加に向けた管理画面・計測システムの基盤を強化。

---

## [v3.5] - 2026-02-11
### Added
- **System Status Indicator**: 画面右上に「System Status」ランプ（緑/赤）を導入。接続状態をリアルタイムで可視化。
- **外部Cronリンク**: 管理画面から `cron-job.org` へ直接アクセスできるクイックリンクを追加。

### Changed
- **外部Cron統合**: Vercelの無料プラン制限（1日1回）を回避するため、`cron-job.org` による外部スケジュール実行へ移行。
- **データ通信の最適化**: `api/go` および `data_service` の記録処理を軽量化。Vercelでのタイムアウト・接続エラーを徹底的に削減。
- **Vercel Cron設定**: 念の為のバックアップとして、毎日午前8時（日本時間）の自動実行を設定。

### Fixed
- **計測漏れ問題の解消**: 計測データがGoogle Sheetsに記録されない問題を、通信処理の高速化と外部サービス統合により解決。
- **PIDなしクリックの救済**: IDが欠落している直接アクセスも `direct_visit` として漏らさず記録。


---

## [v3.4] - 2026-02-10
### Added
- **垂直階層レイアウト**: 運用（上部）と解析（下部）を明確に分離し、スクロールだけで全情報を把握できるUX。
- **UI完全日本語化**: ガバナンス指針に基づき、全ラベル・ボタンを日本語へ統一。

---

## [v3.0] - 2026-02-09
### Added
- **Cockpit UI**: 新しい管理画面の基礎（v3系）を構築。
- **収益トラッキング**: 売上、EPC、AOVの集計機能を完全統合。
