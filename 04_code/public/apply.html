<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AirFuture | ご購入・お問い合わせ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;900&family=Noto+Sans+JP:wght@400;900&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Outfit', 'Noto Sans JP', sans-serif;
            background: #f8fafc;
        }

        .glass {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .floating {
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-15px);
            }
        }

        .ion-particle {
            position: absolute;
            border-radius: 50%;
            background: #6366f1;
            opacity: 0.1;
            pointer-events: none;
            animation: pulse 3s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.4);
            }
        }
    </style>
</head>

<body class="min-h-screen flex items-center justify-center p-6 overflow-hidden">
    <!-- Particles -->
    <div class="ion-particle" style="width: 300px; height: 300px; top: -100px; left: -100px;"></div>
    <div class="ion-particle" style="width: 200px; height: 200px; bottom: -50px; right: -50px;"></div>

    <div class="max-w-sm w-full relative z-10 text-center">
        <div class="relative mb-8 floating">
            <div class="w-28 h-28 mx-auto relative">
                <img src="/mascot.png" alt="AirFuture-kun" class="w-full h-full object-contain filter drop-shadow-2xl">
            </div>
            <div
                class="absolute -right-2 top-0 bg-indigo-500 text-white text-[9px] font-black px-3 py-1 rounded-full shadow-lg">
                AirFuture-kun !</div>
        </div>

        <div class="glass rounded-[40px] p-8 shadow-2xl">
            <h1 class="text-xl font-black text-slate-800 mb-4 tracking-tighter">
                公式ストアへ移動中...
            </h1>
            <p class="text-xs text-slate-500 font-bold mb-8 leading-relaxed">
                安全にリダイレクトしています。<br>
                そのままでお待ちください。
            </p>

            <div class="w-full h-2 bg-slate-100 rounded-full mb-6 overflow-hidden">
                <div class="h-full bg-indigo-600 animate-[pulse_1s_ease-in-out_infinite]" style="width: 100%"></div>
            </div>

            <p class="mt-6 text-[10px] text-slate-400 font-black uppercase tracking-widest">Official Secure Gateway</p>
        </div>
    </div>

    <script>
        const DESTINATION = "https://docs.google.com/forms/d/e/1FAIpQLSeWT9E471JbvDv9qN9aP4e3oSuW6-EPQEeqpNF5JFFbEFPxcg/viewform";

        async function handleApply() {
            console.log('Starting Auto-Redirect Sequence...');

            // 1. Resolve PID & LP_ID
            const urlParams = new URLSearchParams(window.location.search);
            let pid = urlParams.get('pid');
            let lp_id = urlParams.get('lp') || localStorage.getItem('af_lp') || 'mini_main';

            if (!pid) {
                pid = localStorage.getItem('af_pid');
            }
            if (!pid) {
                const match = document.cookie.match(/(^|;)\s*af_pid\s*=\s*([^;]+)/);
                if (match) pid = match[2];
            }

            // Fallback for direct traffic that lost its tag
            if (!pid) {
                pid = 'direct_visit_recovered';
                console.warn('PID not found, defaulting to recovery tag');
            }

            console.log('Resolved PID:', pid, 'LP:', lp_id);

            // 2. Log CV
            if (pid) {
                const storageKey = 'cv_sent_' + pid;
                // Allow duplicate CVs if it's a generic tag or explicitly enabled for debugging
                const isGeneric = pid.includes('direct_visit');

                if (isGeneric || !localStorage.getItem(storageKey)) {
                    try {
                        localStorage.setItem(storageKey, 'true');
                        // Use keepalive to ensure request completes after navigation
                        await fetch(`/api/log_cv?pid=${pid}&lp=${lp_id}`, {
                            method: 'POST',
                            keepalive: true,
                            cache: 'no-store'
                        });
                        console.log('CV Logged');
                    } catch (e) {
                        console.error('CV Logging failed', e);
                    }
                } else {
                    console.log('CV already sent for this PID:', pid);
                }
            }

            // 3. Construct Destination URL
            let finalDest = DESTINATION;
            // Google Forms might not need parameters, but we can pass them if pre-fill is supported later
            // if (pid) {
            //     const url = new URL(DESTINATION);
            //     url.searchParams.set('usp', 'pp_url');
            //     url.searchParams.set('entry.123456', pid); // Example pre-fill
            //     finalDest = url.toString();
            // }

            // 4. Redirect after 800ms buffer (enough for keepalive request to fire)
            setTimeout(() => {
                window.location.replace(finalDest);
            }, 800);
        }

        // Auto-run on load
        window.addEventListener('load', handleApply);
    </script>
</body>

</html>